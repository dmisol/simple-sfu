<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <div id="div"> </div>
    <script>
        // get ID from params and use it to setup WebSocket
        const urlParams = new URLSearchParams(window.location.search);

        const videoParent = document.getElementById("div");

        console.log(videoParent);

        const id = urlParams.get('id');
        var ws = new WebSocket("ws://localhost:8080/ws");
        let pc = new RTCPeerConnection();

        let pcsub = new Map();


        ws.onopen = pub();
        // Process 
        ws.onmessage = function(event) {
            console.log("onmessage()" + event);
            var data = event.data;
            var pl = JSON.parse(data);
            console.log(pl);
            switch (pl.action) {
                case "pub":
                    pub(pl.data)
                    return
                case "sub":
                    sub(pl.id, pl.data)
                    return
                case "inv":
                    inv(pl.id)
                    return
                default:
                    console.log("unexpected", pl.action)
            }
        }

        function sub(id, ans) {
            if (pcsub.has(id)) {
                let d = atob(ans);
                let pl = JSON.parse(d);
                console.log(pl);
                let newpc = pcsub.get(id);
                newpc.setRemoteDescription(pl)
                return
            }
            console.log("no such id " + id);
        }

        function inv(id) {
            let newpc = new RTCPeerConnection();
            newpc.ontrack = function(event) {
                const el = document.createElement(event.track.kind)
                el.srcObject = event.streams[0]
                el.autoplay = true
                    //el.controls = true

                const video = document.createElement('video');
                videoParent.appendChild(el);
            }

            newpc.oniceconnectionstatechange = e => console.log(newpc.iceConnectionState)

            // Offer to receive 1 audio, and 1 video track
            newpc.addTransceiver('video', {
                direction: 'sendrecv'
            })
            newpc.addTransceiver('audio', {
                direction: 'sendrecv'
            })

            newpc.createOffer()
                .then(offer => {
                    newpc.setLocalDescription(offer);
                    pcsub.set(id, newpc);
                    let js = {
                        "action": "sub",
                        "id": id,
                        "data": offer,
                    }
                    ws.send(JSON.stringify(js))
                })
                .catch(alert)
        }


        function pub(ans) {
            console.log("pub()" + ans);
            if (ans != null) {
                let d = atob(ans);
                let pl = JSON.parse(d);
                console.log(pl);
                pc.setRemoteDescription(pl)
                return
            }

            console.log("start publishing");
            // start publishing
            navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                })
                .then(stream => {
                    console.log(stream)
                    let stream_settings = stream.getVideoTracks()[0].getSettings();
                    let stream_width = stream_settings.width;
                    let stream_height = stream_settings.height;

                    console.log('Width: ' + stream_width);
                    console.log('Height: ' + stream_height);

                    const video = document.createElement('video');
                    videoParent.appendChild(video);

                    video.srcObject = stream
                    stream.getTracks().forEach(track => pc.addTrack(track, stream));
                    video.play();
                    video.muted = true;

                    //console.log(stream);

                    pc.createOffer()
                        .then(offer => {
                            pc.setLocalDescription(offer)
                            let js = {
                                "action": "pub",
                                "data": offer
                            }
                            ws.send(JSON.stringify(js))

                            //alert("OFFER: " + offer)
                            return
                        })
                        .catch(alert)
                }).catch(alert)
        }
    </script>

</body>

</html>